<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRUD</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header></header>

    <main class="container my-3">
      <h3>Mantenimiento de productos</h3>

      <form action="" method="post" id="form-producto" autocomplete="off">

        <input type="hidden" id="idproducto">

        <div class="card">
          <div class="card-header">
            <strong>Complete los datos solicitados</strong>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12 mb-2">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control rounded-0"
                    id="descripcion"
                    minlength="5"
                    name="descripcion"
                    required
                    autofocus
                  />
                  <label for="descripcion">Descripción</label>
                </div>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="form-floating">
                  <select
                    name="garantia"
                    id="garantia"
                    class="form-select rounded-0"
                    required
                  >
                    <option value="">Seleccione</option>
                    <option value="0">Sin garantía</option>
                    <option value="3">3 Meses</option>
                    <option value="6">6 Meses</option>
                    <option value="12">1 año</option>
                    <option value="24">2 años</option>
                    <option value="36">3 años</option>
                  </select>
                  <label for="garantia">Garantía</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    name="precio"
                    id="precio"
                    pattern="[0-9.]+"
                    title="Solo se permiten números"
                    class="form-control rounded-0 text-end"
                    required
                  />
                  <label for="precio">Precio</label>
                </div>
              </div>
              <!-- ./col-md-6 -->
            </div>
            <!-- ./row -->
          </div>
          <!-- ./card-body -->
          <div class="card-footer text-end">
            <button type="reset" class="btn rounded-0 btn-outline-secondary" id="btnCancelar">
              Cancelar
            </button>
            <button type="submit" class="btn rounded-0 btn-primary" id="btnGuardar">
              Guardar
            </button>
          </div>
        </div>
        <!-- ./card -->
      </form>

      <style>
        .table tbody tr td:nth-child(4){ text-align: right; }
        
        .table tbody tr 
          td:nth-child(1),
          td:nth-child(3),
          td:nth-child(5)
          { text-align: center; }

      </style>

      <div class="table-resposive mt-3">
        <table class="table table-bordered" id="tabla-productos">
          <colgroup>
            <col style="width: 10%;">
            <col style="width: 40%;">
            <col style="width: 15%;">
            <col style="width: 15%;">
            <col style="width: 20%;">
          </colgroup>
          <thead>
            <tr>
              <th class="text-center">ID</th>
              <th>Descripción</th>
              <th>Garantía</th>
              <th>Precio</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Datos asíncronos -->
          </tbody>
        </table>
      </div>

    </main>

    <footer></footer>

    <script>
      const API_URL = 'http://localhost:3000/api/productos'

      const formulario = document.getElementById('form-producto')
      const tabla = document.querySelector('#tabla-productos tbody')
      
      const idproducto = document.getElementById('idproducto') //caja oculta, contener el ID (PK)
      const descripcion = document.getElementById('descripcion') //elemento de formulario
      const garantia = document.getElementById('garantia')
      const precio = document.getElementById('precio')

      const btnGuardar = document.getElementById('btnGuardar')
      const btnCancelar = document.getElementById('btnCancelar')

      //Retorna el botón guardar a su estado original
      btnCancelar.addEventListener('click', () => {
        btnGuardar.innerText = 'Guardar'
      })

      //Obtener los datos (backend) > renderizar en la tabla
      async function obtenerProductos(){
        const response = await fetch(API_URL, { method: 'get' })
        const productos = await response.json()
        //console.log(productos)

        //Reiniciamos el contenido de la tabla
        tabla.innerHTML = '';
        
        productos.forEach(producto => {
          //Crear una nueva fila y celdas con los datos contenidos en JSON
          const row = tabla.insertRow() //<tr></tr>

          row.insertCell().textContent = producto.id //<td></td>
          row.insertCell().textContent = producto.descripcion //<td></td>
          row.insertCell().textContent = producto.garantia //<td></td>
          row.insertCell().textContent = producto.precio //<td></td>
          
          //La última celda contendrá 2 botones (funcionalidad)
          const actionCell = row.insertCell()

          //Botón 1: Editar
          const editButton = document.createElement('button')
          editButton.textContent = 'Editar'
          editButton.classList.add('btn')
          editButton.classList.add('btn-info')
          editButton.classList.add('btn-sm')
          editButton.onclick = () => cargarParaEdicion(producto)

          //Botón 2: Eliminar
          const deleteButton = document.createElement('button')
          deleteButton.textContent = 'Eliminar'
          deleteButton.classList.add('btn')
          deleteButton.classList.add('btn-danger')
          deleteButton.classList.add('btn-sm')
          deleteButton.onclick = () => eliminarProducto(producto.id, producto.descripcion)

          //Agregando ambos botones a la última celda
          actionCell.appendChild(editButton)
          actionCell.appendChild(deleteButton)
        });
      }

      async function eliminarProducto(id, descripcion){
        //console.log(id, descripcion)
        if (confirm(`¿Está seguro de eliminar el producto: ${descripcion}?`)){ 
          try{
            const response = await fetch(API_URL + `/${id}` , { method: 'delete' })
            
            if (!response.ok){
              throw new Error(`Error al eliminar: ${descripcion}`)
            }

            //Eliminado correctamente...
            const result = await response.json()
            console.log(result)
            obtenerProductos()

          }catch(e){
            console.error(e)
          }
        }
      }

      async function cargarParaEdicion(producto){
        idproducto.value = producto.id
        descripcion.value = producto.descripcion
        garantia.value = producto.garantia
        precio.value = producto.precio

        btnGuardar.innerText = 'Actualizar'
      }

      //Al pulsar el botón Guardar (submit) - DEBEMOS VERIFICAR SI: registrar | actualizar
      formulario.addEventListener("submit", async (event) => {
        event.preventDefault() //Anulado el evento submit

        //Para guardar, necesitamos almacenar los datos en formato JSON
        //preparamos un objeto JS con la misma estructura
        const data = {
          descripcion: descripcion.value,
          garantia: parseInt(garantia.value),
          precio: parseFloat(precio.value)
        }

        //Enviar los datos (1. URL, 2. Verbo, 3. Tipo dato, 4. JSON)
        try{
          //¿Actualizamos o registramos?
          let response = null

          if (idproducto.value == ''){
            response = await fetch(API_URL, { 
              method: 'post',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            })
          }else{
            //Actualizar...
            response = await fetch(API_URL + `/${idproducto.value}`, { 
              method: 'put',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            })
          }
          
          const result = await response.json()
          console.log(result)
          btnGuardar.innerText = 'Guardar'
          formulario.reset()
          obtenerProductos()
        }catch(e){
          console.error(e)
        }
      })

      //Cuando la página esté lista, se ejecutará obtenerProductos
      document.addEventListener('DOMContentLoaded', obtenerProductos)

    </script>

  </body>
</html>
